# Sample Data Generation
*datagen.py* is used to generate the sample datasets:
  * <dataset>.flashing_nbbo
    * Simulate the *public* NBBO market data feed disseminated by the exchanges
  * <dataset>.flashing_orders
    * Simulate the *proprietary* order activity of the market participant under review
    * Generated orders are priced to follow the NBBO bid/ask in market-data dataset


## Market Data (NBBO)
The NBBO is generated by a mid price Geometric Brownian Motion, plus a normal distributed bid-ask spread:

$bid_t=5\times\prod_{i=0}^{t} (1+r_i)-sp_t$

$ask_t=5\times\prod_{i=0}^{t} (1+r_i)+sp_t$

where $r\sim{}N(0, 0.1\%),~~sp\sim{}N(0.02, 0.01)$

Data points are generated every second, with a noise term of $N(0, 100ms)$

NBBO quoted size follows a Poisson distribution with $\lambda=2$: $size\sim{}Pois(2)\times100$


## Orders Parameters
The appearance of orders are random arrival, so the interval between each two orders can be modeled by exponential distribution.
$orderTime_i=marketOpenTime+\sum_{i=0}^{t}interval_i\times20s$
where $interval\sim{}Exp(0.1)$

The sizes of orders follows the same distribution of NBBO generator. And the prices are randomly generated between the as-of NBB and NBO. This gives us the flexibility to assume them filled or able to cancel.

Each order have 50%/50% chance to be an IOC (Immediate or Cancel) or Day order.

## Order Lifecycle
*Assumption*: All exchanges' response time is $d\sim{}U(5ms, 20ms)$

All orders get acknowledged at the latency $d$ after sent.

If it is a Day order, it can transition to these statuses:
  1. Normally canceled (50% probability): Canceled after $x\sim{}U(10s, 100s)$ seconds
  1. Flash canceled (10% probability): Canceled after $x\sim{}U(100ms, 500ms)$ seconds
  1. Normally replaced (10% probability): Replaced after $x\sim{}U(10s, 100s)$ seconds, either size +100 or price +$0.01^*^
  1. Flash replaced (10% probability): Canceled after $x\sim{}U(100ms, 500ms)$ seconds, either size +100 or price +$0.01
  1. Filled (20% probability): Filled at order price after $x\sim{}U(1s, 30s)$ seconds

If it is IOC:
  1. Immediate cancel: Canceled with latency $d$
  1. Immediate fill: Filled at order price with latency $d$

^*^ In the interest of keeping the data generation script simple (replaced orders are not filled, even if the randomized price would otherwise result in a fill).


## Running the Tool

Navigate to the generation folder in the repository and run the following commands.

Note that the data generation tool depends on numpy and pandas. It is recommended to install them under a virtual environment.


```bash
  $ cd use_cases/examples/flashing_detection/data_generator

  $ pip3 install numpy pandas google-cloud-bigquery

  $ python3 datagen.py --date 2022-08-15 --symbol ABC --project_id=$PROJECT_ID --bq_dataset=regrep_source
```

The tool takes ~3mins to complete and uploads to BigQuery into two tables:
  1. <dataset>.flashing_nbbo
  1. <dataset>.flashing_orders

